apiService:
  preDeployHook: |-
    # Run commands before deploying the API server, e.g. installing an admin policy.
    # Refer to https://docs.skypilot.co/en/latest/cloud-setup/policy.html for more details about admin policy.
    # Remember to set the admin policy in the config section below.
    echo "Pre-deploy hook"

    # Uncomment the following lines to install the admin policy

    echo "Installing admin policy"
    pip install git+https://github.com/michaelvll/admin-policy-examples

    # Revert to working version of vast sdk
    pip uninstall -y vastai-sdk
    pip install "vastai-sdk<0.2.2"

    # Install cudoctl, fix broken cudoctl api
    echo "Installing cudoctl and fixing broken API"
    curl https://download.cudocompute.com/cli/cudoctl_linux_amd64.tar.gz -o /tmp/cudoctl_linux_amd64.tar.gz
    cd /tmp
    tar --no-same-owner -xvf cudoctl_linux_amd64.tar.gz
    mv cudoctl /usr/local/bin    
    sed -i '1d' /usr/local/lib/python3.10/site-packages/cudo_compute/cudo_api.py


  initialBasicAuthCredentials: "skypilot:$apr1$c1h4rNxt$2NnL7dIDUV0tWsnuNMGSr/"
  authUserHeaderName: X-authentik-email
  dbConnectionSecretName: postgresql://skypilot-db:skypilot-db@skypilot-db-rw:5432/skypilot-db
  # Set the DB connection string directly. This is a shortcut for setting the DB connection string in a secret.
  # @schema type: [string, null]
  # dbConnectionString: null

  # Set ~/.sky/ssh_node_pools.yaml content on the API server
  # Updating this value will not restart the API server but it will take tens of seconds to take effect on the API server.
  # You can verify config updates on the server by exec-ing into the pod and running `cat ~/.sky/ssh_node_pools.yaml`
  # Refer to https://docs.skypilot.co/en/latest/reservations/existing-machines.html#defining-ssh-node-pools for more details.
  # @schema type: [string, null]

  # Skip resource check for the API server, not recommended for production deployment
  skipResourceCheck: true # we have low requests, high limits
  # Set resource requests and limits for the API server
  # @schema skipProperties:true
  resources:
    # Request a moderate amount of resources for an remote API server by default, which meets the
    # basic requirements for team usage at medium scale.
    requests:
      cpu: "4"
      memory: "8Gi"
      ephemeral-storage: "10Gi"
    limits:
      cpu: "8"
      memory: "16Gi"
      ephemeral-storage: "50Gi"

  # Configure how to manage API server logs
  logs:
    retention:
      # Whether to enable log retention
      enabled: true
      # The size of the log file to retain
      size: 10M
    persistence:
      # Persist /root/sky_logs on a dedicated PVC
      enabled: true
      # Use an existing claim for logs instead of creating a new one
      existingClaim: ""
      # Storage class for the log PVC - leave empty for cluster default
      storageClassName: "topolvm-provisioner"
      # Access mode for the log PVC
      accessMode: ReadWriteOnce
      # Requested size for the log PVC
      size: 10Gi
      # Optional selector for binding to specific PVs
      selector: {}
      # Optional fixed volume name to bind to
      volumeName: ""
      # Optional annotations for the log PVC
      annotations: {}

  # Background cleaner sidecar to prune stale SkyPilot artifacts
  cleaner:
    # Whether to run the cleaner sidecar
    enabled: true
    # Delete files/directories older than this many days
    retentionDays: 2
    # How often to run the cleanup loop (seconds)
    intervalSeconds: 3600
    # Automatically cleans ~/.sky/api_server/clients and, if enabled, persistent log storage

storage:
  # Enable/disable persistent storage
  # With this enabled, SkyPilot will use a PV to persist the internal data like states, logs, lock files, catalog, etc.
  # Refer to https://docs.skypilot.co/en/latest/reference/architecture/state.html for more details.
  enabled: true
  # Storage class name - leave empty to use cluster default
  storageClassName: "topolvm-provisioner"
  # Access modes - ReadWriteOnce or ReadWriteMany depending on what is supported by the storage class
  accessMode: ReadWriteOnce
  # Storage size
  size: 100Gi
  # Optional selector for matching specific PVs
  # selector:
  #   matchLabels:
  #     name: rclone-skypilot-dev-api-server
  # Optional volume name for binding to specific PV
  # volumeName: "skypilot-dev-api-server"
  # Optional annotations
  annotations: {}
  # Use an existing claim instead of creating a new PVC
  # existingClaim: "skypilot-dev-api-server"


# RBAC controls the in-cluster permissions for the SkyPilot API server.
rbac:
  # If false, the serviceaccount and rbac policies will not be created. An external service account is expected in this case.
  create: true
  # If not specified, the service account name will be generated by the chart.
  serviceAccountName: ""
  # Namespace-scoped rules that are granted to the release namespace and rbac.grantedNamespaces.
  namespaceRules:
    # Required for managing pods and their lifecycle
    - apiGroups: [ "" ]
      resources: [ "pods", "pods/status", "pods/exec", "pods/portforward" ]
      verbs: [ "*" ]
    # Required for managing services for SkyPilot Pods
    - apiGroups: [ "" ]
      resources: [ "services" ]
      verbs: [ "*" ]
    # Required for managing SSH keys
    - apiGroups: [ "" ]
      resources: [ "secrets" ]
      verbs: [ "*" ]
    # Required for retrieving reason when Pod scheduling fails.
    - apiGroups: [ "" ]
      resources: [ "events" ]
      verbs: [ "get", "list", "watch" ]
    # Required for syncing workspace config changes to ConfigMap
    - apiGroups: [ "" ]
      resources: [ "configmaps" ]
      verbs: [ "get", "patch" ]
    # Required for high-availability controller
    - apiGroups: ["apps"]
      resources: ["deployments", "deployments/status"]
      verbs: ["*"]
    - apiGroups: [""]
      resources: ["persistentvolumeclaims"]
      verbs: ["*"]
  # Cluster-scoped rules for API server.
  clusterRules:
    # Required for getting node resources.
    - apiGroups: [ "" ]
      resources: [ "nodes" ]
      verbs: [ "get", "list", "watch" ]
    # Required for querying GPUs.
    - apiGroups: [ "" ]
      resources: [ "pods" ]
      verbs: [ "get", "list", "watch" ]
    # Required for autodetecting runtime classes
    - apiGroups: [ "node.k8s.io" ]
      resources: [ "runtimeclasses" ]
      verbs: [ "get", "list", "watch" ]
    # Required for exposing services.
    - apiGroups: [ "networking.k8s.io" ]
      resources: [ "ingressclasses" ]
      verbs: [ "get", "list", "watch" ]
    # Required for accessing ingress service.
    # TODO(aylei): unify the ingress of API server and task pods, then remove this.
    - apiGroups: [""]
      resources: ["services"]
      verbs: ["list", "get"]
  # This allows the API server to grant permissions to SkyPilot Pods and system components.
  # `kubernetes.remote_identity` must be specified in the sky config if this is disabled.
  manageRbacPolicies: false
  # This allows the API server to manage system components in the skypilot-system namespace.
  # Required for object store mounting.
  # You can disable this if you do not need additional capabilities of system components like
  # object store mounting or you manage system components manually, i.e. outside of SkyPilot.
  manageSystemComponents: false

  # Custom annotations for the API server service account.
  # @schema type: [object, null]
  serviceAccountAnnotations: null

# Refer to https://docs.skypilot.co/en/latest/reference/api-server/api-server-admin-deploy.html#optional-configure-cloud-accounts for more details to configure different cloud accounts.
# kubernetesCredentials add additional kubernetes cluster permissions to the API server.
kubernetesCredentials:
  # Enable/disable using the API server's cluster for workloads
  useApiServerCluster: false
  # Use the `kube-credentials` secret containing the kubeconfig to authenticate to Kubernetes
  useKubeconfig: true
  # Name of the secret containing the kubeconfig file. Only used if useKubeconfig is true.
  kubeconfigSecretName: cluster-credentials
  # Namespace to use for in-cluster resources
  # @schema type: [string, null]
  inclusterNamespace: null

awsCredentials:
  enabled: true
  # Name of the secret containing the aws credentials. Only used if enabled is true.
  awsSecretName: aws-credentials
  # Key name used to set AWS_ACCESS_KEY_ID.
  accessKeyIdKeyName: aws_access_key_id
  # Key name used to set AWS_SECRET_ACCESS_KEY.
  secretAccessKeyKeyName: aws_secret_access_key

gcpCredentials:
  enabled: true
  # TODO(romilb): This can be made optional by using the project in the key json by default.
  # @schema type: [string, null]
  projectId: {{ skypilot_dev_gcp_project_id }}
  # Name of the secret containing the gcp credentials. Only used if enabled is true.
  gcpSecretName: gcp-credentials
  image: registry.${dns_domain}/gergorg/google-cloud-sdk:{{ packages.google_cloud_sdk.version }}

# Populate RunPod credentials from the secret with key `api_key`
runpodCredentials:
  enabled: true
  # Name of the secret containing the RunPod credentials. Only used if enabled is true.
  runpodSecretName: runpod-credentials

# Populate RunPod credentials from the secret with key `api_key`
paperspaceCredentials:
  enabled: false
  # Name of the secret containing the RunPod credentials. Only used if enabled is true.
  paperspaceSecretName: paperspace-credentials

# Populate Cudo credentials from the secret with key `api_key`
cudoCredentials:
  enabled: true
  # Name of the secret containing the RunPod credentials. Only used if enabled is true.
  cudoSecretName: cudo-credentials

# Populate DO credentials from the secret with key `api_key`
digitaloceanCredentials:
  enabled: true
  # Name of the secret containing the RunPod credentials. Only used if enabled is true.
  digitaloceanSecretName: digitalocean-credentials

# Populate OCI credentials from the secret with key `api_key`
ociCredentials:
  enabled: true
  # Name of the secret containing the OCI credentials, with required keys "config" and "key". Only used if enabled is true.
  ociSecretName: oci-credentials  

# Populate Lambda credentials from the secret with key `api_key`
lambdaCredentials:
  enabled: true
  # Name of the secret containing the Lambda credentials. Only used if enabled is true.
  lambdaSecretName: lambda-credentials

# Populate Vast credentials from the secret with key `api_key`
vastCredentials:
  enabled: true
  # Name of the secret containing the Vast credentials. Only used if enabled is true.
  vastSecretName: vast-credentials

# Populate Nebius credentials from the secret with nebius credentials.
nebiusCredentials:
  enabled: false
  # @schema type: [string, null]
  tenantId: null
  # Name of the secret containing the Nebius credentials. Only used if enabled is true.
  nebiusSecretName: nebius-credentials

r2Credentials:
  enabled: false
  # Name of the secret containing the r2 credentials. Only used if enabled is true.
  r2SecretName: r2-credentials

# Extra init containers to run before the api container
# @schema type: [array, null]; item: object
extraInitContainers: null

# Set securityContext for the api pod
podSecurityContext:
  # runAsNonRoot: true
  capabilities:
    drop:
    - ALL  
  seccompProfile:
    type: RuntimeDefault 
  # runAsUser: 10001
  # runAsGroup: 10001
  # fsGroup: 10001    
  allowPrivilegeEscalation: false 

# Set securityContext for the api container inside the api pod
securityContext:
  capabilities:
    drop:
    - ALL
  allowPrivilegeEscalation: false

runtimeClassName: "kata"
