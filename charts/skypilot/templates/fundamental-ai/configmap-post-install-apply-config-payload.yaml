{{- $fullName := include "skypilot.fullname" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-apply-config-payload
data:
  apply-config.sh: |-
    #!/bin/sh
    set -euo pipefail
    api_url="http://{{ $fullName }}-api-service/internal/dashboard/workspaces/config"
    payload_file="/config/payload.json"

    echo "Posting SkyPilot config to: $api_url"
    echo "Payload file: $payload_file"
    echo "Payload contents:"
    cat "$payload_file"

    for i in $(seq 1 30); do
      echo "Attempt $i/30"
      http_code=$(curl -sS -o /tmp/skypilot-config-response.json -w "%{http_code}" \
        -H "Content-Type: application/json" -X POST "$api_url" \
        --data-binary "@$payload_file" || true)
      if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
        echo "Applied SkyPilot config"
        echo "Response ($http_code):"
        cat /tmp/skypilot-config-response.json || true
        break
      fi
      echo "Request failed with status $http_code"
      echo "Response body:"
      cat /tmp/skypilot-config-response.json || true
      echo "Waiting for SkyPilot API to be ready..."
      sleep 5
    done

    if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
      echo "Failed to apply SkyPilot config after retries"
      exit 1
    fi

    echo "Looking for deployments in current namespace suffixed with -api-server"
    deployment_targets=$(kubectl get deployments \
      -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
      awk '/-api-server$/')

    if [ -z "$deployment_targets" ]; then
      echo "No deployments with suffix -api-server found"
      exit 0
    fi

    echo "$deployment_targets" | while read -r deployment_name; do
      if [ -n "$deployment_name" ]; then
        echo "Restarting deployment ${deployment_name}"
        kubectl rollout restart deployment "$deployment_name"
      fi
    done

    echo "Completed deployment restart(s)"
  payload.json: |-
    {
      "config": {
        "kubernetes": {
          "allowed_contexts": [
            "lambda"
          ]
        },
        "jobs": {
          "controller": {
            "consolidation_mode": true,
            "resources": {
              "cloud": "aws",
              "cpus": "4+",
              "memory": "16+",
              "disk_size": 100
            }
          }
        },
        "allowed_clouds": [
          "aws",
          "kubernetes",
          "runpod",
          "cudo",
          "gcp",
          "do",
          "oci",
          "vast",
          "lambda"
        ]
      },
      "env_vars": {
        "SKYPILOT_IS_FROM_DASHBOARD": "true",
        "SKYPILOT_USER_ID": "dashboard",
        "SKYPILOT_USER": "dashboard"
      }
    }
