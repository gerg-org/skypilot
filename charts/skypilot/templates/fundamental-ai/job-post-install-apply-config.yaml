{{- $fullName := include "skypilot.fullname" . -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $fullName }}-apply-config
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    app: {{ $fullName }}-apply-config
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        app: {{ $fullName }}-apply-config
        retort/skypilot-egress: "true"
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      restartPolicy: OnFailure
      volumes:
        - name: apply-config-payload
          configMap:
            name: {{ $fullName }}-apply-config-payload
      containers:
        - name: apply-config
          image: REGISTRYURL/gergorg/curl:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: apply-config-payload
              mountPath: /config
          command:
            - /bin/sh
            - -c
          args:
            - |
              set -euo pipefail
              api_url="http://{{ $fullName }}-api-service/api/v1/workspaces/config"
              payload_file="/config/payload.json"
              echo "Posting SkyPilot config to: $api_url"
              echo "Payload file: $payload_file"
              echo "Payload contents:"
              cat "$payload_file"
              for i in $(seq 1 30); do
                echo "Attempt $i/30"
                http_code=$(curl -sS -o /tmp/skypilot-config-response.json -w "%{http_code}" \
                  -H "Content-Type: application/json" -X POST "$api_url" \
                  --data-binary "@$payload_file" || true)
                if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                  echo "Applied SkyPilot config"
                  echo "Response ($http_code):"
                  cat /tmp/skypilot-config-response.json || true
                  exit 0
                fi
                echo "Request failed with status $http_code"
                echo "Response body:"
                cat /tmp/skypilot-config-response.json || true
                echo "Waiting for SkyPilot API to be ready..."
                sleep 5
              done
              echo "Failed to apply SkyPilot config after retries"
              exit 1

